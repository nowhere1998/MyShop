@model MyShop.Models.Order

@{
    ViewData["Title"] = "Chi tiết đơn hàng";
}

<div class="container mt-4" id="billArea">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-primary mb-0">Chi tiết đơn hàng</h2>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">

            <form asp-action="Edit" method="post">
                <input type="hidden" asp-for="Id" />

                <!-- THÔNG TIN KHÁCH HÀNG -->
                <h5 class="mb-3 text-secondary">Thông tin khách hàng</h5>

                <div class="row">
                    <div class="col">
                        <label class="form-label">Mã đơn hàng</label>
                        <input asp-for="OrderCode" class="form-control bg-light" readonly />
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col">
                        <label class="form-label">Họ tên</label>
                        <input asp-for="FullName" class="form-control bg-light" readonly />
                    </div>
                    <div class="col">
                        <label class="form-label">Email</label>
                        <input asp-for="Email" class="form-control bg-light" readonly />
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col">
                        <label class="form-label">Số điện thoại</label>
                        <input asp-for="Phone" class="form-control bg-light" readonly />
                    </div>
                    <div class="col">
                        <label class="form-label">Địa chỉ giao hàng</label>
                        <input asp-for="ShippingAddress" class="form-control bg-light" readonly />
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label">Ghi chú</label>
                    <input asp-for="Note" class="form-control bg-light" readonly />
                </div>

                <!-- FIELD ẨN -->
                <!-- FIELD ẨN (ĐÚNG) -->
                <input type="hidden" asp-for="PaymentMethod" />
                <input type="hidden" asp-for="PaymentStatus" />
                <input type="hidden" asp-for="SubtotalAmount" />
                <input type="hidden" asp-for="TotalAmount" />
                <input type="hidden" asp-for="DiscountAmount" />
                <input type="hidden" asp-for="ShippingFee" />


                <!-- DANH SÁCH SẢN PHẨM -->
                <hr class="my-4" />
                <h5 class="text-secondary mb-3">Danh sách sản phẩm</h5>

                <table class="table table-bordered align-middle">
                    <thead class="table-dark text-center">
                        <tr>
                            <th style="width:80px">Ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th style="width:100px">SL</th>
                            <th style="width:140px">Giá</th>
                            <th style="width:160px">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderDetails)
                        {
                            <tr>
                                <td class="text-center">
                                    <img src="@item.Product.Image"
                                         class="img-thumbnail rounded"
                                         style="max-width:50px" />
                                </td>
                                <td>@item.Product.Name</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">
                                    @item.Product.Price.GetValueOrDefault().ToString("N0") đ
                                </td>
                                <td class="text-end fw-semibold text-success">
                                    @string.Format("{0:N0}", item.Quantity * item.Product.Price.GetValueOrDefault()) đ
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="mt-3 no-print">
                    <label class="form-label">Trạng thái đơn hàng</label>
                    <select asp-for="OrderStatus" class="form-select" id="orderStatus">
                        <option value="pending">Chờ xử lý</option>
                        <option value="shipping">Đang giao</option>
                        <option value="completed">Hoàn thành</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>


                <!-- TỔNG TIỀN -->
                <div class="row mt-4">
                    <div class="col-md-6 offset-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Tạm tính</span>
                                <strong>@((Model.SubtotalAmount ?? 0).ToString("N0")) đ</strong>
                            </li>

                            <li class="list-group-item d-flex justify-content-between">
                                <span>Giảm giá</span>
                                <strong class="text-danger">
                                    -@((Model.DiscountAmount ?? 0).ToString("N0")) đ
                                </strong>
                            </li>

                            <li class="list-group-item d-flex justify-content-between">
                                <span>Phí giao hàng</span>
                                <strong>@((Model.ShippingFee ?? 0).ToString("N0")) đ</strong>
                            </li>

                            <li class="list-group-item d-flex justify-content-between bg-light">
                                <span class="fw-bold">Tổng tiền</span>
                                <span class="fw-bold text-success fs-5">
                                    @((Model.TotalAmount ?? 0).ToString("N0")) đ
                                </span>
                            </li>

                        </ul>
                    </div>
                </div>

                <!-- BUTTON -->
                <div class="text-end mt-4 no-print">
                    <a asp-action="Index" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Trở lại
                    </a>
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fas fa-save"></i> Lưu lại
                    </button>
                    <a asp-action="Print"
                       asp-route-id="@Model.Id"
                       target="_blank"
                       class="btn btn-primary">
                        <i class="fas fa-print"></i> In hóa đơn
                    </a>
                </div>

            </form>

        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const select = document.getElementById("orderStatus");

            const rules = {
                pending: ["pending", "shipping", "completed", "cancelled"],
                shipping: ["shipping", "completed", "cancelled"],
                completed: ["completed"],
                cancelled: ["cancelled"]
            };

            function applyRule() {
                const current = select.value;
                const allowed = rules[current] || [];

                Array.from(select.options).forEach(opt => {
                    opt.hidden = !allowed.includes(opt.value);
                });
            }

            // Áp dụng khi load trang
            applyRule();

            // Áp dụng khi thay đổi
            select.addEventListener("change", applyRule);
        });
    </script>
}
