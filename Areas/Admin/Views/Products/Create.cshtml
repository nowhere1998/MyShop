@model MyShop.Models.Product

@{
    ViewData["Title"] = "Thêm sản phẩm";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">Thêm sản phẩm</h3>
    </div>

    <form asp-action="Create" method="post">

        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label asp-for="CategoryId" class="form-label">Danh mục</label>
                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.CategoryId"></select>
            </div>

            <div class="col-md-6">
                <label asp-for="DealerId" class="form-label">Nhà cung cấp</label>
                <select asp-for="DealerId" class="form-control" asp-items="ViewBag.DealerId"></select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label asp-for="Name" class="form-label">Tên sản phẩm</label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="Slug" class="form-label">Slug</label>
                <input asp-for="Slug" readonly class="form-control" />
                <span asp-validation-for="Slug" class="text-danger"></span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label asp-for="Price" class="form-label">Giá</label>
                <input asp-for="Price" type="number" class="form-control" />
            </div>

            <div class="col-md-6">
                <label asp-for="SalePrice" class="form-label">Giá khuyến mãi</label>
                <input asp-for="SalePrice" type="number" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label for="" class="form-label">Hình ảnh : </label>
            <button type="button" id="btnBrowse">Chọn ảnh chính</button>
            <input asp-for="Image" class="" />
            <div>
                <img src="" id="PictureView" class="mt-2" width="100" />
            </div>
            <span asp-validation-for="Image" class="text-danger"></span>
        </div>

        <div class="form-group mt-3">
            <label class="form-label">Ảnh phụ (tối đa 5 ảnh):</label>

            <button type="button" id="btnBrowseGallery" class="btn btn-primary btn-sm">
                Chọn ảnh phụ
            </button>

            <!-- Input hidden để lưu danh sách ảnh dạng JSON -->
            <input type="hidden" asp-for="GalleryImages" id="GalleryImages" />

            <!-- Preview ảnh -->
            <div id="GalleryPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>

            <span asp-validation-for="GalleryImages" class="text-danger"></span>
        </div>



        <div class="mb-3">
            <label asp-for="Description" class="form-label">Mô tả</label>
            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label asp-for="Status" class="form-label">Trạng thái</label>
                <select asp-for="Status" class="form-control">
                    <option value="active">Hiển thị</option>
                    <option value="inactive">Ẩn</option>
                </select>
            </div>
        </div>


        <div class="text-end">
            <a asp-action="Index" class="btn btn-secondary">
                Trở lại
            </a>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Lưu lại
            </button>
        </div>

    </form>
</div>

@section Scripts {
    <script type="text/javascript" src="~/lib/jqueryui/jquery-ui.min.js"></script>
    <script src="~/elfinder/js/elfinder.min.js"></script>
    <script src="~/ckeditor/ckeditor.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            if ($('#btnBrowse') != undefined) {
                $('#btnBrowse').click(function () {
                    var fm = $('<div id="elfinder" />').dialogelfinder({
                        url: '/quan-ly-tep-tin/connector',
                        baseUrl: "/elfinder/",
                        width: 840,
                        height: 450,
                        destroyOnClose: true,
                        title: 'Quản lý tệp tin',
                        getFileCallback: function (files, fm) {
                            $('#Image').val('/' + files[0].path);
                            $('#PictureView').attr('src', '/' + files[0].path);
                        },
                        commandsOptions: {
                            getfile: {
                                multiple: true,
                                oncomplete: 'close',
                                folders: false
                            }
                        }
                    }).dialogelfinder('instance');
                })
            }
        });
        CKEDITOR.replace('Content');
    </script>

    <script type="text/javascript">
               function renderGallery(images) {
            const container = $("#GalleryPreview");
            container.html("");
            images.forEach((img, index) => {
               const imgWrapper = $(`<div class="gallery-item"><img src="${img}"><button type="button" class="gallery-remove">×</button></div>`);
                // Xử lý click xóa
                imgWrapper.find("button").click(function () {
                    images.splice(index, 1); // xóa ảnh khỏi mảnga
                    $("#GalleryImages").val(JSON.stringify(images)); // cập nhật input hidden
                    renderGallery(images); // render lại gallery
                });

                container.append(imgWrapper);
            });
        }
                     $('#btnBrowseGallery').click(function () {
            var fm = $('<div/>').dialogelfinder({
                url: '/quan-ly-tep-tin/connector',
                baseUrl: "/elfinder/",
                width: 840,
                height: 450,
                destroyOnClose: true,
                title: 'Quản lý tệp tin',

                getFileCallback: function (files, fm) {

                    // Ép thành mảng
                    let list = [];
                    if (Array.isArray(files)) list = files;
                    else list = [files];

                    // Lấy danh sách ảnh cũ trong input
                    let oldList = [];
                    try {
                        oldList = JSON.parse($("#GalleryImages").val() || "[]");
                    } catch { oldList = []; }

                    // Convert files mới
                    let newImages = list.map(f => "/" + (f.path ?? f.url ?? f.name));

                    // Ghép ảnh cũ + mới
                    let merged = [...oldList, ...newImages];

                    // Giới hạn 5 ảnh
                    if (merged.length > 5) {
                        alert("Bạn chỉ được chọn tối đa 5 ảnh!");
                        merged = merged.slice(0, 5);
                    }

                    // Lưu lại vào input hidden
                    $("#GalleryImages").val(JSON.stringify(merged));

                    // Hiển thị toàn bộ ảnh
                    renderGallery(merged);
                },

                commandsOptions: {
                    getfile: {
                        multiple: true,
                        oncomplete: 'close',
                        folders: false
                    }
                }
            }).dialogelfinder('instance');
        });

    </script>
    <script>
        $(document).ready(function () {
            const galleryValue = $("#GalleryImages").val();
            if (galleryValue) {
                try {
                    const images = JSON.parse(galleryValue);
                    if (images.length > 0) {
                        renderGallery(images);
                    }
                } catch (e) {
                    console.error("GalleryImages JSON lỗi", e);
                }
            }
        });
    </script>

    <script>
        function toSlug(str) {
            return str
                .toLowerCase()
                .replace(/đ/g, "d")
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // bỏ dấu tiếng Việt
                .replace(/[^a-z0-9\s-]/g, "")                     // bỏ ký tự đặc biệt
                .trim()
                .replace(/\s+/g, "-")                             // khoảng trắng → "-"
                .replace(/-+/g, "-");                              // bỏ trùng dấu "-"
        }

        document.getElementById("Name").addEventListener("input", function () {
            document.getElementById("Slug").value = toSlug(this.value);
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }


}
<style>
    .gallery-item {
        position: relative;
        display: inline-block;
    }

        .gallery-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

    .gallery-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 22px;
        height: 22px;
        border-radius: 50%; /* 👈 hình tròn */
        border: none;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 14px;
        line-height: 22px;
        text-align: center;
        cursor: pointer;
        opacity: 0; /* 👈 ẩn */
        transform: scale(0.8);
        transition: all 0.2s ease;
    }

    .gallery-item:hover .gallery-remove {
        opacity: 1; /* 👈 hover mới hiện */
        transform: scale(1);
    }
</style>

