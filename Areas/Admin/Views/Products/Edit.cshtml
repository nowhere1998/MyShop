@model MyShop.Models.Product

@{
    ViewData["Title"] = "Edit sản phẩm";
}

<div class="container mt-4">
    <h3 class="text-primary mb-3">Edit sản phẩm</h3>

    <form asp-action="Edit" method="post">
        <input type="hidden" asp-for="Id" />

        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <!-- Danh mục + NCC -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Danh mục</label>
                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories">
                    <option value="">-- Chọn danh mục --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nhà cung cấp</label>
                <select asp-for="DealerId" class="form-control" asp-items="ViewBag.DealerId"></select>
            </div>
        </div>

        <!-- Name + Slug -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Tên sản phẩm</label>
                <input asp-for="Name" id="Name" class="form-control" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Slug</label>
                <input asp-for="Slug" id="Slug" class="form-control" readonly />
            </div>
        </div>

        <!-- Giá -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Giá</label>
                <input asp-for="Price" type="number" min="0" class="form-control" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Giá khuyến mãi</label>
                <input asp-for="SalePrice" type="number" min="0" class="form-control" />
            </div>
        </div>

        <!-- Ảnh chính -->
        <div class="mb-3">
            <label class="form-label">Ảnh chính</label><br />
            <button type="button" id="btnBrowse" class="btn btn-primary btn-sm">Chọn ảnh</button>
            <input asp-for="Image" type="hidden" />
            <div>
                <img id="PictureView" src="@Model.Image" class="mt-2 border rounded" width="120" />
            </div>
        </div>

        <!-- ẢNH PHỤ -->
        <div class="mb-3">
            <label class="form-label">Ảnh phụ (tối đa 5)</label><br />
            <button type="button" id="btnBrowseGallery" class="btn btn-primary btn-sm">
                Chọn ảnh phụ
            </button>

            <!-- NGUỒN DỮ LIỆU DUY NHẤT -->
            <input type="hidden"
                   asp-for="GalleryImages"
                   id="GalleryImages"
                   value='@Model.GalleryImages' />

            <div id="GalleryPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
        </div>

        <!-- Mô tả -->
        <div class="mb-3">
            <label class="form-label">Mô tả</label>
            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
        </div>

        <!-- Trạng thái -->
        <div class="mb-3">
            <label class="form-label">Trạng thái</label>
            <select asp-for="Status" class="form-control">
                <option value="active">Hiển thị</option>
                <option value="inactive">Ẩn</option>
            </select>
        </div>

        <div class="text-end">
            <a asp-action="Index" class="btn btn-secondary">Trở lại</a>
            <button type="submit" class="btn btn-success">Lưu</button>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/jqueryui/jquery-ui.min.js"></script>
    <script src="~/elfinder/js/elfinder.min.js"></script>
    <script src="~/ckeditor/ckeditor.js"></script>

    <script>
        CKEDITOR.replace('Description');

        function toSlug(str) {
            return str.toLowerCase()
                .replace(/đ/g, "d")
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9\s-]/g, "")
                .trim()
                .replace(/\s+/g, "-")
                .replace(/-+/g, "-");
        }

        $("#Name").on("input", function () {
            $("#Slug").val(toSlug(this.value));
        });
    </script>

    <script>
        function renderGallery(images) {
            const box = $("#GalleryPreview");
            box.html("");

            images.forEach((img, index) => {
                const item = $(`
                    <div class="gallery-item">
                        <img src="${img}">
                        <button type="button" class="gallery-remove">×</button>
                    </div>
                `);

                item.find(".gallery-remove").click(function () {
                    images.splice(index, 1);
                    $("#GalleryImages").val(JSON.stringify(images));
                    renderGallery(images);
                });

                box.append(item);
            });
        }

        $(document).ready(function () {
            const raw = $("#GalleryImages").val();
            if (!raw) return;

            try {
                const images = JSON.parse(raw);
                renderGallery(images);
            } catch {
                console.error("GalleryImages JSON lỗi");
            }
        });

        $("#btnBrowseGallery").click(function () {
            $('<div/>').dialogelfinder({
                url: '/quan-ly-tep-tin/connector',
                baseUrl: "/elfinder/",
                width: 840,
                height: 450,
                destroyOnClose: true,
                getFileCallback: function (files) {
                    let oldList = JSON.parse($("#GalleryImages").val() || "[]");
                    let list = Array.isArray(files) ? files : [files];
                    let newImgs = list.map(f => "/" + f.path);

                    let merged = [...oldList, ...newImgs].slice(0, 5);

                    $("#GalleryImages").val(JSON.stringify(merged));
                    renderGallery(merged);
                },
                commandsOptions: {
                    getfile: { multiple: true, oncomplete: 'close', folders: false }
                }
            });
        });

        $("#btnBrowse").click(function () {
            $('<div/>').dialogelfinder({
                url: '/quan-ly-tep-tin/connector',
                baseUrl: "/elfinder/",
                getFileCallback: function (files) {
                    $("#Image").val("/" + files[0].path);
                    $("#PictureView").attr("src", "/" + files[0].path);
                }
            });
        });
    </script>

    @await Html.PartialAsync("_ValidationScriptsPartial")
}

<style>
    .gallery-item {
        position: relative;
    }

        .gallery-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

    .gallery-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: none;
        background: rgba(0,0,0,.7);
        color: #fff;
        cursor: pointer;
        opacity: 0;
        transition: .2s;
    }

    .gallery-item:hover .gallery-remove {
        opacity: 1;
    }
</style>
